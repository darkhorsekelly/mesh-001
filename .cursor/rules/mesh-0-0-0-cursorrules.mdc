---
name: mesh-0-0-0-cursorrules
description: The "AI Guardrails" ensuring high-fidelity implementation of MESH 95.
alwaysApply: true
---

# MESH 1995: Cursor Rules & Coding Standards

## 0. Personal Formatting & Communication Prefixes
- **Comment Capitalization:** Use lowercase after the first word in comments (e.g., // the engine resolves ticks, not // The Engine Resolves Ticks).
- **Comment Placement:** Never place comments on the same line as code. Place them on the line above the target code.
- **Identity:** Write comments as a lead developer on the project. Never use "agent" language (e.g., avoid "I have updated this because...").
- **No Meta-Comments:** Do not leave comments explaining edits, responding to prompts, or using "TODO: Changed per instructions." Comments must only provide context for the code that currently exists.

## 1. The Source of Truth Hierarchy
1. **Scope & Implementation:** `project_specs_0_0_0.md`. Prioritize for immediate boundaries.
2. **Design Intent & Flavor:** `game_design_doc_mesh_95_0_0_1.md`. Consult for naming, aesthetic "feel," and future-proofing.
3. **Strict Isolation:** Do not implement features from the GDD not in the Spec, but ensure current code is compatible with them.

## 2. Core Philosophy: "The Engine is a Library"
- **Rule:** `src/engine` must be **Pure TypeScript**. No `react`, `pixi.js`, `socket.io`, or `fs` imports.
- **Fixed-Point (FP) Absolute:** NEVER use floating-point numbers for engine logic (position, velocity, distance). Use the established `FP` type and `math.ts` utilities (scaling factor 1000).
- **Deterministic Pipeline:** State mutation only occurs in the `tickResolver` via a pipeline of reducers: `applyActions -> applyManeuver -> applyZoomStateTransition`.

## 3. Network & State Architecture
- **The Network is a Service:** Initialize Socket.io as a **Module-level Singleton**. Do not initialize inside React `useEffect`. Hooks should only manage subscriptions.
- **Server Authority:** The client is a "Pure Terminal." 
    - **No Action Shadowing:** Do not store `localActionQueue` in React state.
    - **Authoritative Sync:** Intent is emitted via `CMD_QUEUE_ACTION`. The queue is only "real" once the server broadcasts it back from the SQLite source of truth.
    - **Ghosts:** Ghost projections must use the `ServerPendingActions` list + `projectionSystem` logic. Never predict position based on local-only state.

## 4. Visual & UI "Sensor Stack" Rules
- **The FP Boundary:** The UI speaks in Screen Pixels. The Engine speaks in FP. Conversion happens exactly once in `DisplayUtils` or `fpToScreen` mappers. No raw FP integers in JSX.
- **Stale Data:** Always check `last_seen_tick` before rendering entity details. Entities not seen in the current tick must display "STALE DATA" labels.
- **Aesthetic:** High-contrast Black & White. Use `PIXI.Graphics` for circles (celestials) and points (entities). No textures.
- **Selection:** Use the `inputEvents.ts` bus to decouple clicks from reactions. All selection (Viewport or List) must emit to the bus.

## 5. Audio as Data
- **Pattern:** `interaction -> emit(ACTION) -> AudioBus.on(ACTION) -> PlaySound`. 
- **Rule:** Never play sounds directly from `onClick` handlers. Audio must be driven by the event bus to ensure synchronization.

## 6. TypeScript & Persistence
- **Strictness:** `noImplicitAny: true`, `strictNullChecks: true`.
- **Database:** Use `better-sqlite3` synchronously with WAL mode. All `saveTick` operations must be wrapped in an atomic SQL transaction encompassing Ticks, Actions, and Snapshots.
- **Naming:** - Components: `PascalCase`
    - Systems: `camelCase`
    - Constants: `UPPER_SNAKE_CASE`

## 7. Anti-Patterns to Avoid
- **"God Components":** Do not mix logic, rendering, and input.
- **Floating Point Leak:** Never pass raw `number` types from the engine to the UI without passing through a formatter.
- **Shadowing:** Never create a client-side state that "mirrors" what should be in the database.